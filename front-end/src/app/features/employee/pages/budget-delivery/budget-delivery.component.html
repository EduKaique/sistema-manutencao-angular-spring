<!-- Loading State (Opcional, simples) -->
<div *ngIf="isLoading" style="display: flex; justify-content: center; padding: 20px;">
  <span>Carregando solicitação...</span>
</div>

<!-- Conteúdo Principal (Só exibe quando carregar) -->
<div *ngIf="!isLoading && request">
  <!-- Ações superiores -->
  <div class="top-actions">
    <a class="voltar-pagina-inicial" (click)="onVoltarPaginaInicial()">
      <mat-icon class="voltar-icon">arrow_back</mat-icon>
      <span>Voltar para Página Inicial</span>
    </a>

    <button
      mat-flat-button
      color="primary"
      class="finalizar-solicitacao-btn"
      *ngIf="canFinalizarSolicitacao()"
      (click)="finalizarSolicitacao(finalizacaoDialogTemplate)"
    >
      <mat-icon>check</mat-icon>
      Finalizar Solicitação
    </button>
  </div>

  <div class="main-content">
    <!-- Card Detalhes da Solicitação -->
    <mat-card class="detalhes-card">
      <div class="detalhes-header">
        <div class="detalhes-header-left">
          <mat-icon class="detalhes-icon" color="primary">search</mat-icon>
          <span class="detalhes-title">Detalhes da Solicitação</span>
          <span class="detalhes-id">#{{ request.id }}</span>
        </div>
        <span class="detalhes-date">{{ request.requestDate | date:'dd/MM/yyyy \'às\' HH:mm:ss' }}</span>
        
        <!-- Badge de Status usando a cor vinda do backend -->
        <div class="detalhes-status">
          <span class="detalhes-status-label">Status</span>
          <span class="detalhes-status-badge" 
                [style.backgroundColor]="request.status.cor" 
                [style.color]="'#fff'">
            {{ request.status.nome }}
          </span>
        </div>
      </div>

      <div class="detalhes-info-row">
        <div class="detalhes-info">
          <span class="detalhes-info-label">Item</span>
          <span class="detalhes-info-value">{{ request.equipmentName }}</span>
        </div>
        <div class="detalhes-info">
          <span class="detalhes-info-label">Categoria</span>
          <span class="detalhes-info-value">{{ request.categoryName }}</span>
        </div>
        <div class="detalhes-info">
          <span class="detalhes-info-label">Autor da Solicitação</span>
          <div class="detalhes-info-autor">
            <span class="detalhes-info-value">{{ request.client.name }}</span>
            <mat-icon class="detalhes-autor-icon" color="primary">person</mat-icon>
          </div>
        </div>
      </div>

      <div class="detalhes-defeito">
        <span class="detalhes-defeito-label">Descrição do Defeito</span>
        <span class="detalhes-defeito-value">
          {{ request.defectDescription }}
        </span>
      </div>
    </mat-card>

    <div class="cards-row">
      <!-- Card Técnico Responsável -->
      <mat-card class="tecnico-card">
        <div class="tecnico-header">
          <mat-icon class="tecnico-icon" color="primary">groups</mat-icon>
          <span class="tecnico-title">Técnico Responsável</span>
        </div>

        <ng-container *ngIf="!responsavel; else responsavelPreenchido">
          <div class="tecnico-content">Nenhum Técnico Atribuído</div>
          <button mat-stroked-button color="primary" class="atribuir-btn" (click)="abrirDialog(dialogTemplate)">
            Atribuir Responsável
          </button>
        </ng-container>

        <ng-template #responsavelPreenchido>
          <div class="tecnico-content">
            <div><b>Nome:</b> {{ responsavel!.name }}</div>
            <!-- Exibe cargo se existir na model, senão omite -->
            <div *ngIf="dataAtribuicao"><b>Atribuído em:</b> {{ dataAtribuicao }}</div>
          </div>
          <button mat-stroked-button color="primary" class="atribuir-btn" (click)="abrirDialog(dialogTemplate)">
            <mat-icon>sync_alt</mat-icon>
            Trocar Responsável
          </button>
        </ng-template>
      </mat-card>

      <!-- Card Orçamento/Manutenção com abas -->
      <mat-card class="orcamento-manutencao-card">
        <mat-tab-group class="orcamento-tabs" [(selectedIndex)]="selectedTab">
          <!-- Aba Orçamentos -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon class="tab-icon" color="primary">attach_money</mat-icon>
              Orçamentos
            </ng-template>

            <div class="orcamento-content">
              <ng-container *ngIf="temOrcamento; else orcamentoVazio">
                <div class="orcamento-total-label">Valor Total do Orçamento</div>
                <div class="orcamento-total">R$ {{ valorOrcamento | number:'1.2-2' }}</div>
                <div class="orcamento-servicos-label">Serviços Inclusos</div>
                <div class="orcamento-servicos">
                  <!-- Se vier do backend como array de objetos, o .join no TS resolve para string -->
                  {{ servicosInclusos }}
                </div>
              </ng-container>

              <ng-template #orcamentoVazio>
                <div class="orcamento-empty">Nenhum Orçamento Efetuado</div>
                <button
                  mat-flat-button
                  color="primary"
                  class="orcamento-btn"
                  [disabled]="false"
                  (click)="abrirDialogOrcamento(orcamentoDialogTemplate)"
                >
                  Efetuar Orçamento
                </button>
              </ng-template>
            </div>
          </mat-tab>

          <!-- Aba Manutenção -->
          <mat-tab>
            <ng-template mat-tab-label>
              <mat-icon class="tab-icon" color="primary">groups</mat-icon>
              Manutenção
            </ng-template>

            <div class="manutencao-content" [class.tem-manutencao]="temManutencao">
              <ng-container *ngIf="temManutencao; else manutencaoVazio">
                <div class="manutencao-descricao">
                  <b>Descrição da Manutenção:</b>
                  <span>{{ descricaoManutencao }}</span>
                </div>
                <div class="manutencao-orientacao">
                  <b>Orientações para o Cliente:</b>
                  <span>{{ orientacaoCliente }}</span>
                </div>

                <!-- Botão editar manutenção -->
                <button
                  mat-flat-button
                  color="primary"
                  class="manutencao-btn"
                  (click)="abrirDialogManutencao(manutencaoDialogTemplate)"
                >
                  <mat-icon>edit</mat-icon>
                  Editar Manutenção
                </button>
              </ng-container>

              <ng-template #manutencaoVazio>
                <div class="orcamento-empty">Nenhuma Manutenção Efetuada</div>
                <button
                  mat-flat-button
                  color="primary"
                  class="manutencao-btn"
                  [disabled]="false"
                  (click)="abrirDialogManutencao(manutencaoDialogTemplate)"
                >
                  <mat-icon>build</mat-icon>
                  Efetuar Manutenção
                </button>
              </ng-template>
            </div>
          </mat-tab>
        </mat-tab-group>
      </mat-card>
    </div>
  </div>
</div>

<!-- Dialog: Atribuir Responsável -->
<ng-template #dialogTemplate>
  <div class="dialog-container">
    <h2 class="dialog-title">Atribuição de Responsável</h2>

    <mat-form-field appearance="outline" class="dialog-field">
      <mat-label>Atribuir Solicitação Para:</mat-label>
      <!-- INTEGRAÇÃO: Iterando sobre a lista de funcionários da API -->
      <mat-select [(ngModel)]="selectedFuncionario" placeholder="Pesquise/Selecione um Funcionário">
        <mat-option [value]="null">Nenhum</mat-option>
        <mat-option *ngFor="let func of funcionariosDisponiveis" [value]="func">
          {{ func.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <div style="display: flex; gap: 8px;">
      <button mat-stroked-button color="primary" class="dialog-btn" (click)="cancelarDialog()">
        Cancelar
      </button>
      <button mat-flat-button color="primary" class="dialog-btn"
              [disabled]="selectedFuncionario === undefined"
              (click)="atribuirResponsavel()">
        Atribuir
      </button>
    </div>
  </div>
</ng-template>

<!-- Dialog: Efetuar Orçamento -->
<ng-template #orcamentoDialogTemplate>
  <div class="orcamento-dialog">
    <div class="orcamento-dialog-header">
      <div class="orcamento-dialog-title">Efetuar Orçamento</div>
      <button mat-icon-button (click)="fecharDialogOrcamento()" aria-label="Fechar">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="orcamento-dialog-body">
      <mat-form-field appearance="outline" class="orcamento-dialog-field full">
        <mat-label>*Serviços Inclusos na Manutenção</mat-label>
        <!-- INTEGRAÇÃO: Iterando sobre serviços da API e usando propriedades corretas (name/value) -->
        <mat-select
          [(ngModel)]="servicosSelecionados"
          multiple
          placeholder="Selecione os serviços"
          (selectionChange)="atualizarTotal()"
        >
          <mat-option *ngFor="let s of servicosDisponiveis" [value]="s">
            {{ s.nome }} — R$ {{ s.valor_servico | number:'1.2-2' }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline" class="orcamento-dialog-field full">
        <mat-label>Valor Total</mat-label>
        <input
          matInput
          [value]="servicosSelecionados.length ? (valorTotal | currency:'BRL':'symbol-narrow':'1.2-2') : ''"
          placeholder="Total calculado"
          readonly
        />
      </mat-form-field>
    </div>

    <div class="orcamento-dialog-actions">
      <div class="orcamento-dialog-helper">
        * Campo de preenchimento obrigatório
      </div>

      <button
        mat-flat-button
        color="primary"
        class="orcamento-dialog-confirm"
        [disabled]="servicosSelecionados.length === 0"
        (click)="confirmarOrcamento()"
      >
        Efetuar Orçamento
        <mat-icon>check</mat-icon>
      </button>
    </div>
  </div>
</ng-template>

<!-- Dialog: Efetuar Manutenção -->
<ng-template #manutencaoDialogTemplate>
  <div class="manutencao-dialog">
    <div class="manutencao-dialog-header">
      <div class="manutencao-dialog-title">Efetuar Manutenção</div>
      <button mat-icon-button (click)="fecharDialogManutencao()" aria-label="Fechar">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <div class="manutencao-dialog-body">
      <mat-form-field appearance="outline" class="manutencao-dialog-field full">
        <mat-label>*Descrição da Manutenção</mat-label>
        <textarea
          matInput
          rows="5"
          [(ngModel)]="manutencaoDescricaoInput"
          placeholder="Descreva a manutenção"
        ></textarea>
      </mat-form-field>

      <mat-form-field appearance="outline" class="manutencao-dialog-field full">
        <mat-label>*Orientações para o Cliente</mat-label>
        <textarea
          matInput
          rows="4"
          [(ngModel)]="manutencaoOrientacaoInput"
          placeholder="Descreva as orientações"
        ></textarea>
      </mat-form-field>
    </div>

    <div class="manutencao-dialog-actions">
      <div class="manutencao-dialog-helper">
        * Campo de preenchimento obrigatório
      </div>

      <button
        mat-flat-button
        color="primary"
        class="manutencao-dialog-confirm"
        [disabled]="!isManutencaoFormValid()"
        (click)="confirmarManutencao()"
      >
        Efetuar Manutenção
        <mat-icon>check</mat-icon>
      </button>
    </div>
  </div>
</ng-template>

<!-- Dialog: Finalização da Solicitação -->
<ng-template #finalizacaoDialogTemplate>
  <div class="finalizacao-dialog">
    <div class="finalizacao-icon">
      <mat-icon>check</mat-icon>
    </div>
    <div class="finalizacao-title">Solicitação finalizada com sucesso!</div>
    <button
      mat-flat-button
      color="primary"
      class="finalizacao-back-btn"
      (click)="onVoltarPaginaInicial()"
    >
      Voltar para Página Inicial
    </button>
  </div>
</ng-template>