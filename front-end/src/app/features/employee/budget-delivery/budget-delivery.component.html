<app-header></app-header>

<!-- Botão Voltar para Página Inicial -->
<a class="voltar-pagina-inicial" (click)="onVoltarPaginaInicial()">
  <mat-icon class="voltar-icon">arrow_back</mat-icon>
  <span>Voltar para Página Inicial</span>
</a>

<div class="main-content">
  <!-- Card Detalhes da Solicitação -->
  <mat-card class="detalhes-card">
    <div class="detalhes-header">
      <div class="detalhes-header-left">
        <mat-icon class="detalhes-icon" color="primary">search</mat-icon>
        <span class="detalhes-title">Detalhes da Solicitação</span>
        <span class="detalhes-id">#{{ detalhes.id }}</span>
      </div>
      <span class="detalhes-date">{{ detalhes.data | date:'dd/MM/yyyy \'às\' HH:mm:ss' }}</span>
      <div class="detalhes-status">
        <span class="detalhes-status-label">Status</span>
        <span class="detalhes-status-badge">{{ detalhes.status }}</span>
      </div>
    </div>
    <div class="detalhes-info-row">
      <div class="detalhes-info">
        <span class="detalhes-info-label">Item</span>
        <span class="detalhes-info-value">{{ detalhes.item }}</span>
      </div>
      <div class="detalhes-info">
        <span class="detalhes-info-label">Categoria</span>
        <span class="detalhes-info-value">{{ detalhes.categoria }}</span>
      </div>
      <div class="detalhes-info">
        <span class="detalhes-info-label">Autor da Solicitação</span>
        <div class="detalhes-info-autor">
          <span class="detalhes-info-value">{{ detalhes.autor }}</span>
          <mat-icon class="detalhes-autor-icon" color="primary">person</mat-icon>
        </div>
      </div>
    </div>
    <div class="detalhes-defeito">
      <span class="detalhes-defeito-label">Descrição do Defeito</span>
      <span class="detalhes-defeito-value">
        {{ detalhes.defeito }}
      </span>
    </div>
  </mat-card>

  <div class="cards-row">
    <!-- Card Técnico Responsável -->
    <mat-card class="tecnico-card">
      <div class="tecnico-header">
        <mat-icon class="tecnico-icon" color="primary">groups</mat-icon>
        <span class="tecnico-title">Técnico Responsável</span>
      </div>
      <ng-container *ngIf="!responsavel; else responsavelPreenchido">
        <div class="tecnico-content">
          Nenhum Técnico Atribuído
        </div>
        <button mat-stroked-button color="primary" class="atribuir-btn" (click)="abrirDialog(dialogTemplate)">
          Atribuir Responsável
        </button>
      </ng-container>
      <ng-template #responsavelPreenchido>
        <div class="tecnico-content">
          <div><b>Nome:</b> {{ responsavel.nome }}</div>
          <div><b>Cargo:</b> {{ responsavel.cargo }}</div>
          <div><b>Atribuído em:</b> {{ dataAtribuicao }}</div>
        </div>
        <button mat-stroked-button color="primary" class="atribuir-btn" (click)="abrirDialog(dialogTemplate)">
          <mat-icon>sync_alt</mat-icon>
          Trocar Responsável
        </button>
      </ng-template>
    </mat-card>

    <!-- Card Orçamento/Manutenção com abas -->
    <mat-card class="orcamento-manutencao-card">
      <mat-tab-group class="orcamento-tabs" [(selectedIndex)]="selectedTab">
        <!-- Aba Orçamentos -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon" color="primary">attach_money</mat-icon>
            Orçamentos
          </ng-template>
          <div class="orcamento-content">
            <ng-container *ngIf="temOrcamento; else orcamentoVazio">
              <div class="orcamento-total-label">Valor Total do Orçamento</div>
              <div class="orcamento-total">R$ {{ valorOrcamento | number:'1.2-2' }}</div>
              <div class="orcamento-servicos-label">Serviços Inclusos</div>
              <div class="orcamento-servicos">
                {{ servicosInclusos }}
              </div>
            </ng-container>
            <ng-template #orcamentoVazio>
              <div class="orcamento-empty">Nenhum Orçamento Efetuado</div>
              <button mat-flat-button color="primary" class="orcamento-btn" [disabled]="false">
                Efetuar Orçamento
              </button>
            </ng-template>
          </div>
        </mat-tab>
        <!-- Aba Manutenção -->
        <mat-tab>
          <ng-template mat-tab-label>
            <mat-icon class="tab-icon" color="primary">groups</mat-icon>
            Manutenção
          </ng-template>
          <div class="manutencao-content">
            <ng-container *ngIf="temManutencao; else manutencaoVazio">
              <div class="manutencao-descricao">
                <b>Descrição da Manutenção:</b>
                <span>{{ descricaoManutencao }}</span>
              </div>
              <div class="manutencao-orientacao">
                <b>Orientações para o Cliente:</b>
                <span>{{ orientacaoCliente }}</span>
              </div>
            </ng-container>
            <ng-template #manutencaoVazio>
              <div class="orcamento-empty">Nenhuma Manutenção Efetuada</div>
              <button mat-flat-button color="primary" class="manutencao-btn" [disabled]="false">
                <mat-icon>build</mat-icon>
                Efetuar Manutenção
              </button>
            </ng-template>
          </div>
        </mat-tab>
      </mat-tab-group>
    </mat-card>
  </div>
</div>

<!-- Dialog Template (fora de qualquer <div>) -->
<ng-template #dialogTemplate>
  <div class="dialog-container">
    <h2 class="dialog-title">Atribuição de Responsável</h2>
    <mat-form-field appearance="outline" class="dialog-field">
      <mat-label>Atribuir Solicitação Para:</mat-label>
      <mat-select [(ngModel)]="selectedFuncionario" placeholder="Pesquise/Selecione um Funcionário">
        <mat-option [value]="null">Nenhum</mat-option>
        <mat-option *ngFor="let f of funcionarios" [value]="f">{{ f.nome }} - {{ f.cargo }}</mat-option>
      </mat-select>
    </mat-form-field>
    <div style="display: flex; gap: 8px;">
      <button mat-stroked-button color="primary" class="dialog-btn" (click)="cancelarDialog()">
        Cancelar
      </button>
      <button mat-flat-button color="primary" class="dialog-btn"
        [disabled]="selectedFuncionario === undefined"
        (click)="atribuirResponsavel()">
        Atribuir
      </button>
    </div>
  </div>
</ng-template>
